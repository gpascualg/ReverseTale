
include(ExternalProject)

set(DEP_BASE ${CMAKE_BINARY_DIR}/dep)
SET_PROPERTY(DIRECTORY PROPERTY EP_BASE ${DEP_BASE})

set(BSON_DIR ${DEP_BASE}/Install/EP_libbson)
set(MONGOC_DIR ${DEP_BASE}/Install/EP_mongo-c-driver)
set(MONGOCXX_DIR ${DEP_BASE}/Install/EP_mongo-cxx-driver)
set(CPPFORMAT_DIR ${DEP_BASE}/Install/EP_cppformat)

ExternalProject_Add(
    EP_libbson
    GIT_REPOSITORY https://github.com/mongodb/libbson.git
    GIT_TAG r1.3
    LOG_DOWNLOAD ON
    LOG_CONFIGURE ON
    LOG_BUILD ON
    LOG_INSTALL ON
    LOG_UPDATE ON
    UPDATE_COMMAND ""
    CMAKE_ARGS -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DENABLE_TESTS=OFF -DCMAKE_INSTALL_PREFIX:PATH=${BSON_DIR} -DINCLUDE_INSTALL_DIR=.
)

ExternalProject_Add_Step(
    EP_libbson
    EP_fix-libbson-alignment
    WORKING_DIRECTORY ${DEP_BASE}/Source/EP_libbson
    COMMAND git stash && git apply --whitespace=fix ${CMAKE_SOURCE_DIR}/cmake/Patches/07-libbson.patch
    DEPENDEES download
)

ExternalProject_Add(
    EP_mongo-c-driver
    GIT_REPOSITORY https://github.com/mongodb/mongo-c-driver.git
    GIT_TAG r1.3
    LOG_DOWNLOAD ON
    LOG_CONFIGURE ON
    LOG_BUILD ON
    LOG_INSTALL ON
    LOG_UPDATE ON
    UPDATE_COMMAND ""
    CMAKE_ARGS -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DBSON_ROOT_DIR=${BSON_DIR} -DBSON_INCLUDE_DIR=${BSON_DIR}/include -DENABLE_TESTS=OFF -DENABLE_EXAMPLES=OFF -DCMAKE_INSTALL_PREFIX:PATH=${MONGOC_DIR} -DINCLUDE_INSTALL_DIR=.
    DEPENDS EP_libbson
)

ExternalProject_Add(
    EP_mongo-cxx-driver
    GIT_REPOSITORY https://github.com/mongodb/mongo-cxx-driver.git
    #GIT_TAG r1.3
    LOG_DOWNLOAD ON
    LOG_CONFIGURE ON
    LOG_BUILD ON
    LOG_INSTALL ON
    LOG_UPDATE ON
    UPDATE_COMMAND ""
    CMAKE_ARGS -DBOOST_ROOT=${BOOST_ROOT} -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DLIBBSON_DIR=${BSON_DIR} -DLIBMONGOC_DIR=${MONGOC_DIR} -DENABLE_TESTS=OFF -DENABLE_EXAMPLES=OFF -DCMAKE_INSTALL_PREFIX:PATH=${MONGOCXX_DIR} -DINCLUDE_INSTALL_DIR=.
    DEPENDS EP_mongo-c-driver
)

ExternalProject_Add_Step(
    EP_mongo-cxx-driver
    EP_fix-find-bson
    WORKING_DIRECTORY ${DEP_BASE}/Source/EP_mongo-cxx-driver/cmake
    COMMAND git stash && git apply --whitespace=fix ${CMAKE_SOURCE_DIR}/cmake/Patches/06-mongocxx.patch
    DEPENDEES download
)

ExternalProject_Add(
    EP_cppformat
    GIT_REPOSITORY https://github.com/cppformat/cppformat.git
    #GIT_TAG r1.3
    LOG_DOWNLOAD ON
    LOG_CONFIGURE ON
    LOG_BUILD ON
    LOG_INSTALL ON
    LOG_UPDATE ON
    UPDATE_COMMAND ""
    CMAKE_ARGS -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DFMT_DOC=OFF -DFMT_TEST=OFF -DCMAKE_INSTALL_PREFIX:PATH=${CPPFORMAT_DIR} -DINCLUDE_INSTALL_DIR=.
)

#set(LIBBSON_LIBRARY_DIRS "${BSON_DIR}/lib" CACHE INTERNAL "")
#set(LIBMONGOC_LIBRARY_DIRS "${MONGOC_DIR}/lib" CACHE INTERNAL "")

#set(LIBMONGOCXX_INCLUDE_DIRS "${MONGOCXX_DIR}/include/mongocxx/v_noabi" CACHE INTERNAL "")
#set(LIBMONGOCXX_LIBRARY_DIRS "${MONGOCXX_DIR}/lib" CACHE INTERNAL "")

#set(LIBBSONCXX_INCLUDE_DIRS "${MONGOCXX_DIR}/include/bsoncxx/v_noabi" CACHE INTERNAL "")
#set(LIBBSONCXX_LIBRARY_DIRS "${MONGOCXX_DIR}/lib" CACHE INTERNAL "")

#set(CPPFORMAT_INCLUDE_DIRS "${CPPFORMAT_DIR}/include" CACHE INTERNAL "")
#set(CPPFORMAT_LIBRARY_DIRS "${CPPFORMAT_DIR}/lib" CACHE INTERNAL "")

#find_library(LIBBSON_LIBRARY bson-static-1.0 ${LIBBSON_LIBRARY_DIRS})
#mark_as_advanced(${LIBBSON_LIBRARY})

#find_library(LIBMONGOC_LIBRARY mongoc-static-1.0 ${LIBMONGOC_LIBRARY_DIRS})
#mark_as_advanced(${LIBMONGOC_LIBRARY})

#find_library(LIBMONGOCXX_LIBRARY NAMES libmongocxx mongocxx.a PATHS ${LIBMONGOCXX_LIBRARY_DIRS})
#mark_as_advanced(${LIBMONGOCXX_LIBRARY})

#find_library(LIBBSONCXX_LIBRARY NAMES libbsoncxx bsoncxx.a PATHS ${LIBBSONCXX_LIBRARY_DIRS})
#mark_as_advanced(${LIBBSONCXX_LIBRARY})

#set (LIBMONGOCXX_LIBRARIES 
#    ${LIBBSON_LIBRARY}
#    ${LIBMONGOC_LIBRARY}
#    ${LIBBSONCXX_LIBRARY}
#    ${LIBMONGOCXX_LIBRARY}
#)
#set(LIBMONGOCXX_LIBRARIES ${LIBMONGOCXX_LIBRARIES} CACHE INTERNAL "")

# [--- WIP: Correct usage by issuing find_package
set(LIBBSON_DIR ${BSON_DIR} CACHE INTERNAL "")
set(LIBMONGOC_DIR ${MONGOC_DIR} CACHE INTERNAL "")

set(CMAKE_MODULE_PATH "${CMAKE_MODULE_PATH};${DEP_BASE}/Source/EP_mongo-cxx-driver/cmake" CACHE INTERNAL "")
set(CMAKE_PREFIX_PATH "${CMAKE_PREFIX_PATH};${BSON_DIR};${MONGOC_DIR};${MONGOCXX_DIR};${CPPFORMAT_DIR}" CACHE INTERNAL "")
